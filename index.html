<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Florida Trip 3/7â€“3/14</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    iframe { pointer-events: auto; }
    .timeline-line { position:absolute; left:20px; top:0; bottom:0; width:2px; background:#e2e8f0; z-index:0; }
  </style>
</head>

<body class="bg-slate-50 text-gray-900 font-sans">
  <!-- ===== Nav ===== -->
  <nav class="bg-indigo-900 text-white p-4 sticky top-0 z-50 shadow-md">
    <div class="container mx-auto flex flex-wrap justify-between items-center gap-3">
      <div>
        <h1 class="font-bold text-lg tracking-tight">Florida Trip 2026 ğŸŒ´</h1>
        <p class="text-[10px] text-indigo-300 italic">March 07 - March 14 Â· SAT â†’ MIA â†’ ORL â†’ SAT</p>
      </div>

      <div class="flex items-center gap-2">
        <button id="copyTodayBtn" class="bg-emerald-600 hover:bg-emerald-500 p-2 rounded-lg text-sm transition">
          <i class="fa-solid fa-copy"></i> <span>è¤‡è£½ä»Šå¤©è¡Œç¨‹</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- ===== Map ===== -->
  <div class="w-full h-72 md:h-96 bg-gray-200 border-b-4 border-indigo-900 shadow-inner">
    <iframe
      id="mapFrame"
      src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d3028207.819705539!2d-81.6!3d27.7!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1szh-TW!2sus!4v1700000000000"
      width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy">
    </iframe>
  </div>

  <main class="container mx-auto px-4 py-10 max-w-5xl">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <!-- Info -->
      <div class="lg:col-span-1 bg-white rounded-3xl border border-slate-200 shadow-sm p-5">
        <div class="flex items-start justify-between gap-2 mb-3">
          <h2 class="font-bold text-indigo-900 text-lg">è¡Œç¨‹è³‡è¨Š</h2>
          <span class="text-[11px] text-gray-500" id="lastUpdatedBadge">æœ€å¾Œæ›´æ–°ï¼šâ€”</span>
        </div>

        <div class="text-sm space-y-2">
          <div class="flex justify-between gap-2">
            <span class="text-gray-500">æ—¥æœŸ</span>
            <span class="font-semibold text-right">3/07â€“3/14ï¼ˆ8å¤©7å¤œï¼‰</span>
          </div>
          <div class="flex justify-between gap-2">
            <span class="text-gray-500">è·¯ç·š</span>
            <span class="font-semibold text-right">SAT â†’ MIA â†’ï¼ˆè‡ªé§•ï¼‰â†’ Orlando â†’ MCO â†’ SAT</span>
          </div>
          <div class="flex justify-between gap-2">
            <span class="text-gray-500">å¿…å»</span>
            <span class="font-semibold text-right">Everglades / South Beach / Gulf Stream / Universal / Epic / KSC(3/12) / Silver Springs</span>
          </div>
          <div class="flex justify-between gap-2">
            <span class="text-gray-500">ç§Ÿè»Šå»ºè­°</span>
            <span class="font-semibold text-right">MIA å–è»Šã€MCO é‚„è»Šï¼ˆone-wayï¼‰</span>
          </div>
        </div>

        <!-- Expenses: Splitwise-like -->
        <div class="mt-5 border-t pt-4">
          <div class="flex items-center justify-between">
            <h3 class="font-bold text-indigo-900">Expensesï¼ˆå¤šäººåˆ†å¸³ï¼‰</h3>
            <button id="toggleExpensesBtn" class="text-sm text-indigo-700 font-semibold hover:underline">
              <span id="toggleExpensesLabel">å±•é–‹</span>
            </button>
          </div>

          <div id="expensesPanel" class="hidden mt-3">
            <!-- Members -->
            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold text-slate-800">æˆå“¡</div>
                <div class="text-xs text-gray-500">æ–°å¢åƒèˆ‡åˆ†å¸³çš„äºº</div>
              </div>

              <div class="flex gap-2 flex-wrap">
                <input id="memberNameInput" class="bg-white border rounded-xl px-3 py-2 text-sm" placeholder="è¼¸å…¥åå­—ï¼ˆä¾‹ï¼šKatieï¼‰"/>
                <button id="addMemberBtn" class="bg-indigo-700 hover:bg-indigo-600 text-white rounded-xl px-3 py-2 text-sm">
                  + æ–°å¢æˆå“¡
                </button>
              </div>

              <div id="membersList" class="mt-3 flex flex-wrap gap-2"></div>
            </div>

            <!-- Add expense -->
            <div class="mt-3 bg-white border border-slate-200 rounded-2xl p-3">
              <div class="font-semibold text-slate-800 mb-2">æ–°å¢èŠ±è²»</div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div class="flex items-center gap-2">
                  <label class="text-xs text-gray-600 w-20">é‡‘é¡</label>
                  <input id="expAmount" type="number" min="0" step="0.01" class="w-full border rounded-xl px-3 py-2 text-sm" placeholder="ä¾‹å¦‚ 45.50"/>
                </div>

                <div class="flex items-center gap-2">
                  <label class="text-xs text-gray-600 w-20">ä»˜æ¬¾äºº</label>
                  <select id="expPayer" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
                </div>

                <div class="flex items-center gap-2">
                  <label class="text-xs text-gray-600 w-20">åˆ†é¡</label>
                  <select id="expCategory" class="w-full border rounded-xl px-3 py-2 text-sm">
                    <option value="tickets">é–€ç¥¨</option>
                    <option value="hotel">ä½å®¿</option>
                    <option value="car">ç§Ÿè»Š</option>
                    <option value="gas">æ²¹éŒ¢</option>
                    <option value="parking">åœè»Š</option>
                    <option value="food">é¤è²»</option>
                    <option value="misc">å…¶ä»–</option>
                  </select>
                </div>

                <div class="flex items-center gap-2">
                  <label class="text-xs text-gray-600 w-20">æ—¥æœŸ</label>
                  <select id="expDay" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-xs text-gray-600 mb-2">åˆ†æ”¤çµ¦èª°ï¼ˆå¯è¤‡é¸ï¼›åªæœ‰åƒèˆ‡çš„äººæ‰å‹¾ï¼‰</div>
                <div id="splitWithBox" class="flex flex-wrap gap-2"></div>
              </div>

              <div class="mt-3 flex items-center gap-2 flex-wrap">
                <input id="expNote" class="flex-1 border rounded-xl px-3 py-2 text-sm" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰ä¾‹å¦‚ï¼šUniversal é–€ç¥¨"/>
                <button id="addExpenseBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl px-3 py-2 text-sm">
                  + åŠ å…¥
                </button>
              </div>
            </div>

            <!-- Expense list + settlement -->
            <div class="mt-3 bg-white border border-slate-200 rounded-2xl p-3">
              <div class="font-semibold text-slate-800 mb-2">èŠ±è²»æ˜ç´°</div>
              <div id="expenseList" class="space-y-2"></div>

              <div class="mt-4 border-t pt-3">
                <div class="font-semibold text-slate-800 mb-2">çµç®—å»ºè­°ï¼ˆèª°æ¬ èª°ï¼‰</div>
                <div id="settlementList" class="text-sm text-slate-700 space-y-1"></div>
              </div>
            </div>

            <div class="mt-2 text-xs text-gray-500">
              æœƒè‡ªå‹•å­˜åˆ°æœ¬æ©Ÿï¼ˆåŒä¸€å°è£ç½®/ç€è¦½å™¨æœ‰æ•ˆï¼‰ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="lg:col-span-2 relative">
        <div class="timeline-line hidden md:block"></div>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-indigo-900">ğŸ“Œ è¡Œç¨‹ï¼ˆé»æ¯å¤©å¯æ”¶åˆï¼‰</h2>
          <div class="text-xs text-gray-500">æç¤ºï¼šé» Day æ¨™é¡Œå¯æ”¶åˆï¼›ä»Šå¤©æœƒè‡ªå‹•é«˜äº®ï¼›IMPORTANT æœƒè‡ªå‹•æäº®ã€‚</div>
        </div>
        <div id="daysContainer" class="space-y-4 relative z-10"></div>
      </div>
    </div>

    <div class="mt-10 p-8 bg-white rounded-3xl border border-slate-200 shadow-sm border-t-4 border-t-indigo-600">
      <h3 class="font-bold text-indigo-900 mb-2 flex items-center gap-2 text-lg">
        <i class="fa-solid fa-car-side"></i> ç§Ÿè»Šèˆ‡äº¤é€šæé†’
      </h3>
      <p class="text-gray-600 text-sm leading-relaxed">
        å»ºè­°ï¼šMIA å–è»Šã€MCO é‚„è»Šï¼ˆone-wayï¼‰ã€‚Miami åœè»Šè²´ã€Orlando æ¨‚åœ’åœè»Šå›ºå®šï¼›3/12 å» KSC å»ºè­°æ—©åˆ°æ¶ Bus Tourã€‚
      </p>
    </div>
  </main>

<script>
  // ===== Trip config =====
  const TRIP_YEAR = 2026;
  const LAST_UPDATED_ISO = "2026-02-10T00:00:00-06:00";

  // ===== Data (8 days) =====
  const tripData = {
    days: [
      {
        id: "d1", month: 3, day: 7, label: "3/07 (Sat)",
        title: "SAT â†’ é‚é˜¿å¯†ï¼ˆMIAï¼‰ï¼‹å—æµ·ç˜",
        reminders: [
          { level: "important", text: "æŠµé” MIA å¾Œå–è»Šï¼›Miami åœè»Šåè²´ï¼Œä½å®¿ç›¡é‡æ‰¾å«åœè»Š" },
          { level: "info", text: "æ™šä¸Š South Beach + Ocean Drive æ•£æ­¥" }
        ],
        stops: [
          { start:"12:00", end:"14:00", name:"é£›è¡Œï¼šSAT â†’ MIA", address:"SAT â†’ MIA", map:"https://maps.google.com/?q=Miami+International+Airport", note:"æ™‚æ®µå¯ä¾ä½ çš„èˆªç­èª¿æ•´ï¼ˆé€™è£¡å…ˆæ”¾ç¯„ä¾‹ï¼‰ã€‚" },
          { travel:"30â€“60 min", start:"14:00", end:"15:00", name:"MIA å–è»Šï¼‹å‰å¾€ä½å®¿", address:"Miami International Airport, 2100 NW 42nd Ave, Miami, FL 33142", phone:"+1 305-876-7000", map:"https://maps.google.com/?q=Miami+International+Airport", note:"ç¢ºèª tollï¼ˆé›»å­æ”¶è²»ï¼‰è¨­å®šã€‚" },
          { travel:"20â€“30 min", start:"17:30", end:"20:30", name:"South Beach å—æµ·ç˜ï¼‹Ocean Drive", address:"Ocean Dr, Miami Beach, FL 33139", map:"https://maps.google.com/?q=South+Beach+Miami", note:"å¤•é™½æ•£æ­¥ï¼‹æ™šé¤ï¼›ç•™æ„åœè»Šè²»ã€‚" }
        ]
      },
      {
        id: "d2", month: 3, day: 8, label: "3/08 (Sun)",
        title: "å¤§æ²¼æ¾¤ Evergladesï¼ˆShark Valleyï¼‰",
        reminders: [
          { level: "important", text: "é˜²æ›¬ï¼‹æ°´ï¼‹å¸½å­ï¼›æ—©åˆ°æ¯”è¼ƒä¸æ’éšŠ" }
        ],
        stops: [
          { start:"09:00", end:"12:30", name:"Shark Valley Visitor Center", address:"36000 SW 8th St, Miami, FL 33194", phone:"+1 305-221-8776", map:"https://maps.google.com/?q=Shark+Valley+Visitor+Center", note:"å¯ç§Ÿè…³è¸è»Šæˆ–æ­ Tramï¼›å¾ˆå®¹æ˜“çœ‹åˆ°é±·é­šã€‚" },
          { travel:"45â€“70 min", start:"16:00", end:"18:30", name:"å› Miami è‡ªç”±æ´»å‹•ï¼ˆLittle Havana å¯é¸ï¼‰", address:"Little Havana, Miami, FL", map:"https://maps.google.com/?q=Little+Havana+Miami", note:"å’–å•¡ï¼‹å¤å·´é¢¨æƒ…è¡—å€ã€‚" }
        ]
      },
      {
        id: "d3", month: 3, day: 9, label: "3/09 (Mon)",
        title: "å¢¨è¥¿å“¥ç£æš–æµï¼ˆGulf Streamï¼‰é«”é©—ï¼‹é–‹å»å¥§è˜­å¤š",
        reminders: [
          { level: "important", text: "ä»Šå¤©ç§»å‹•è¼ƒå¤šï¼šå»ºè­°æ—©å‡ºç™¼ï¼Œæ™šä¸ŠæŠµé” Orlando" },
          { level: "info", text: "Gulf Stream æœ€æœ‰æ„Ÿé€šå¸¸æ˜¯ Palm Beach/Jupiter ä¸€å¸¶çš„æµ·ä¸Šæ´»å‹•" }
        ],
        stops: [
          { start:"09:00", end:"10:30", name:"è‡ªé§•ï¼šMiami â†’ West Palm Beach", address:"Miami to West Palm Beach", map:"https://maps.google.com/?q=Miami+to+West+Palm+Beach", note:"è»Šç¨‹ç´„ 1.5 å°æ™‚ï¼ˆçœ‹äº¤é€šï¼‰ã€‚" },
          { travel:"15â€“25 min", start:"11:30", end:"14:30", name:"Gulf Stream è¿‘æµ·é«”é©—ï¼ˆæµ®æ½›/å‡ºæµ·ï¼Œæ“‡ä¸€ï¼‰", address:"Phil Foster Park / Peanut Islandï¼ˆPalm Beachï¼‰", map:"https://maps.google.com/?q=Phil+Foster+Park", note:"å¦‚æœä½ æŒ‡çš„æ˜¯ Gulfstream Parkï¼ˆè³½é¦¬å ´/å¨›æ¨‚åŸï¼‰ï¼Œå¯æ”¹ Hallandale Beachã€‚" },
          { travel:"2.5â€“3 hr", start:"16:30", end:"19:30", name:"è‡ªé§•ï¼šWest Palm Beach â†’ Orlando", address:"West Palm Beach to Orlando", map:"https://maps.google.com/?q=West+Palm+Beach+to+Orlando", note:"æŠµé”å¾Œå…¥ä½ï¼Œç‚ºéš”å¤©æ¨‚åœ’åšæº–å‚™ã€‚" }
        ]
      },
      {
        id: "d4", month: 3, day: 10, label: "3/10 (Tue)",
        title: "ç’°çƒå½±åŸ Universal Orlandoï¼ˆç©æ•´å¤©ï¼‰",
        reminders: [
          { level: "important", text: "æƒ³æ­éœæ ¼è¯èŒ²ç‰¹å¿«è»Šéœ€ Park-to-Park ç¥¨" },
          { level: "important", text: "å»ºè­°é–‹åœ’å°±åˆ°ï¼ˆæ’éšŠå·®å¾ˆå¤šï¼‰" }
        ],
        stops: [
          { start:"09:00", end:"19:00", name:"Universal Orlando Resortï¼ˆStudios + Islands of Adventureï¼‰", address:"6000 Universal Blvd, Orlando, FL 32819", phone:"+1 407-363-8000", map:"https://www.universalorlando.com/web/en/us", note:"å…©åœ’ä¸€æ—¥è¡Œç¨‹ï¼ˆå¯ä¾éœ€æ±‚èª¿æ•´ï¼‰ã€‚" }
        ]
      },
      {
        id: "d5", month: 3, day: 11, label: "3/11 (Wed)",
        title: "Epic Universeï¼ˆç©æ•´å¤©ï¼‰",
        reminders: [
          { level: "important", text: "æ–°åœ’å€äººæ½®å¾ˆçŒ›ï¼šrope dropï¼ˆé–‹åœ’è¡ç¬¬ä¸€æ³¢ï¼‰" }
        ],
        stops: [
          { start:"09:00", end:"19:00", name:"Universal Epic Universe", address:"Orlando, FL", map:"https://www.universalorlando.com/web/en/us/theme-parks/epic-universe", note:"å…ˆæ’å¿…ç©ï¼šä»»å¤©å ‚/é­”æ³•éƒ¨ç­‰ã€‚" }
        ]
      },
      {
        id: "d6", month: 3, day: 12, label: "3/12 (Thu)",
        title: "è‚¯å°¼è¿ªèˆªå¤©ä¸­å¿ƒ KSCï¼ˆå›ºå®š 3/12ï¼‰",
        reminders: [
          { level: "important", text: "Bus Tour å¯èƒ½é¡æ»¿ï¼šè¶Šæ—©åˆ°è¶Šå¥½" }
        ],
        stops: [
          { start:"08:30", end:"09:30", name:"è‡ªé§•ï¼šOrlando â†’ Kennedy Space Center", address:"Orlando to Merritt Island", map:"https://maps.google.com/?q=Orlando+to+Kennedy+Space+Center", note:"è»Šç¨‹ç´„ 1 å°æ™‚ï¼ˆçœ‹äº¤é€šï¼‰ã€‚" },
          { start:"10:00", end:"17:00", name:"Kennedy Space Center Visitor Complex", address:"Space Commerce Way, Merritt Island, FL 32953", phone:"+1 855-433-4210", map:"https://www.kennedyspacecenter.com/", note:"Rocket Garden / Atlantis / Bus Tourï¼ˆå…ˆæ¶ Bus Tourï¼‰ã€‚" },
          { travel:"1 hr", start:"17:30", end:"18:30", name:"å› Orlando", address:"Orlando, FL", map:"https://maps.google.com/?q=Orlando", note:"æ™šé¤ï¼‹ä¼‘æ¯ã€‚" }
        ]
      },
      {
        id: "d7", month: 3, day: 13, label: "3/13 (Fri)",
        title: "Silver Springsï¼ˆç»ç’ƒèˆ¹/æ¸…æ³‰ï¼‰ä¸€æ—¥",
        reminders: [
          { level: "important", text: "å¸¶é˜²èšŠæ¶²ï¼›æ¸…æ³‰å€æ—©æ™šæº«å·®å¯å¸¶è–„å¤–å¥—" }
        ],
        stops: [
          { start:"09:00", end:"10:30", name:"è‡ªé§•ï¼šOrlando â†’ Silver Springs State Park", address:"1425 NE 58th Ave, Ocala, FL 34470", phone:"+1 352-236-7148", map:"https://maps.google.com/?q=Silver+Springs+State+Park", note:"è»Šç¨‹ç´„ 1.5 å°æ™‚ã€‚" },
          { start:"11:00", end:"14:00", name:"Glass Bottom Boatï¼ˆç»ç’ƒèˆ¹ï¼Œå»ºè­°ï¼‰", address:"Silver Springs State Park", map:"https://maps.google.com/?q=Silver+Springs+Glass+Bottom+Boat", note:"ä¾ç•¶å¤©ç­æ¬¡èª¿æ•´ï¼›ä¹Ÿå¯åŠ æ­¥é“/åˆ’èˆ¹ã€‚" },
          { travel:"1.5 hr", start:"16:00", end:"17:30", name:"å› Orlandoï¼ˆæ•´ç†è¡Œæï¼‰", address:"Orlando, FL", map:"https://maps.google.com/?q=Orlando", note:"æ˜å¤©è¦é£›ï¼Œå»ºè­°æ—©ç¡ã€‚" }
        ]
      },
      {
        id: "d8", month: 3, day: 14, label: "3/14 (Sat)",
        title: "MCO â†’ SAT å›ç¨‹ï¼ˆé‚„è»Šï¼‹ç™»æ©Ÿï¼‰",
        reminders: [
          { level: "important", text: "é‚„è»Šï¼‹å®‰æª¢è¦ç•™ç·©è¡ï¼ˆå»ºè­°èµ·é£›å‰ 2.5ï½3 å°æ™‚åˆ°æ©Ÿå ´ï¼‰" }
        ],
        stops: [
          { start:"09:30", end:"11:00", name:"Orlando International Airportï¼ˆMCOï¼‰é‚„è»Šï¼‹è¾¦ç†ç™»æ©Ÿ", address:"1 Jeff Fuqua Blvd, Orlando, FL 32827", phone:"+1 407-825-2001", map:"https://maps.google.com/?q=Orlando+International+Airport", note:"å¦‚æœä½ æœ€å¾Œè¦å¾ MIA é£›å›ï¼Œä¹Ÿå¯æŠŠé€™å¤©æ”¹ Orlando â†’ Miami æ—©ç§»å‹•ã€‚" },
          { start:"12:00", end:"14:30", name:"é£›è¡Œï¼šMCO â†’ SAT", address:"MCO â†’ SAT", map:"https://maps.google.com/?q=San+Antonio+International+Airport", note:"æ™‚æ®µä¾ä½ çš„èˆªç­èª¿æ•´ï¼ˆé€™è£¡å…ˆæ”¾ç¯„ä¾‹ï¼‰ã€‚" }
        ]
      }
    ]
  };

  // ===== Helpers =====
  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatLastUpdated() {
    try {
      const d = new Date(LAST_UPDATED_ISO);
      return `æœ€å¾Œæ›´æ–°ï¼š${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    } catch { return "æœ€å¾Œæ›´æ–°ï¼šâ€”"; }
  }
  function getTodayKey() {
    const now = new Date();
    return { year: now.getFullYear(), month: now.getMonth()+1, day: now.getDate() };
  }
  function sameDate(a,b){ return a.year===b.year && a.month===b.month && a.day===b.day; }
  function dayKeyObj(dayObj){ return {year: TRIP_YEAR, month: dayObj.month, day: dayObj.day}; }

  function minutesBetween(start, end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    return (eh*60+em) - (sh*60+sm);
  }
  function humanMins(mins){
    if (!Number.isFinite(mins) || mins<=0) return "";
    return `${mins} åˆ†é˜`;
  }

  function buildDayText(dayObj) {
    const lines = [];
    lines.push(`${dayObj.label} Â· ${dayObj.title}`);
    lines.push(`- é‡é»æé†’ï¼š`);
    (dayObj.reminders||[]).forEach(r => lines.push(`  â€¢ ${r.level==="important" ? "IMPORTANT" : "INFO"}ï¼š${r.text}`));
    lines.push("");
    (dayObj.stops||[]).forEach(s => {
      if (s.travel) lines.push(`ğŸš— äº¤é€šæ™‚é–“ï¼š${s.travel}`);
      if (s.start && s.end) lines.push(`${s.start}-${s.end} ${s.name}`);
      else lines.push(`${s.name}`);
      if (s.address) lines.push(`  ğŸ“ ${s.address}`);
      if (s.map) lines.push(`  ğŸ—º ${s.map}`);
      if (s.phone) lines.push(`  â˜ ${s.phone}`);
      if (s.note) lines.push(`  ğŸ“ ${s.note}`);
      lines.push("");
    });
    return lines.join("\n").trim();
  }

  async function copyTextToClipboard(text) {
    await navigator.clipboard.writeText(text);
  }

  function getTodayOrFirstTripDay() {
    const today = getTodayKey();
    const match = tripData.days.find(d => sameDate(today, dayKeyObj(d)));
    return match || tripData.days[0];
  }

  // ===== Render days =====
  function renderDays() {
    const today = getTodayKey();
    const container = document.getElementById("daysContainer");
    container.innerHTML = "";

    tripData.days.forEach((d, idx) => {
      const isToday = sameDate(today, dayKeyObj(d));
      const expandedByDefault = isToday || idx === 0;

      const dayCard = document.createElement("div");
      dayCard.className = `bg-white rounded-3xl shadow-sm border p-0 relative overflow-hidden ${isToday ? "border-amber-300 ring-2 ring-amber-200" : "border-slate-100"}`;

      const header = document.createElement("button");
      header.type = "button";
      header.className = "w-full text-left p-5 hover:bg-indigo-50 transition flex items-start justify-between gap-3";
      header.innerHTML = `
        <div class="relative z-10">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">${d.label}</span>
            ${isToday ? `<span class="text-[11px] bg-amber-100 text-amber-800 px-2 py-1 rounded-full"><i class="fa-solid fa-star"></i> Today</span>` : ""}
          </div>
          <h3 class="text-xl font-bold text-slate-800">${d.title}</h3>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">
              <i class="fa-solid fa-location-dot"></i> ${(d.stops||[]).length} stops
            </span>
          </div>
        </div>

        <div class="shrink-0 flex items-center gap-2">
          <button class="copyDayBtn bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl px-3 py-2 text-sm" data-dayid="${d.id}" type="button">
            <i class="fa-solid fa-copy"></i> è¤‡è£½æœ¬æ—¥
          </button>
          <div class="text-indigo-700 font-semibold text-sm">
            <span class="dayToggleText">${expandedByDefault ? "æ”¶åˆ" : "å±•é–‹"}</span>
            <i class="fa-solid fa-chevron-down ml-2 transition-transform dayChevron ${expandedByDefault ? "rotate-180" : ""}"></i>
          </div>
        </div>
      `;

      const body = document.createElement("div");
      body.className = `px-5 pb-5 ${expandedByDefault ? "" : "hidden"}`;

      const reminderBox = document.createElement("div");
      reminderBox.className = `mt-3 rounded-2xl border p-4 ${isToday ? "bg-amber-50 border-amber-200" : "bg-indigo-50 border-indigo-100"}`;
      reminderBox.innerHTML = `
        <div class="font-bold text-indigo-900 mb-2 flex items-center gap-2">
          <i class="fa-solid fa-bell"></i> é‡é»æé†’
        </div>
        <ul class="text-sm space-y-2">
          ${(d.reminders || []).map(r => {
            const isImp = r.level === "important";
            return `
              <li class="flex gap-2 items-start">
                <span class="mt-2 inline-block w-2 h-2 rounded-full ${isImp ? "bg-amber-500" : "bg-indigo-500"}"></span>
                <span class="inline-block px-2 py-[2px] rounded text-[11px] font-bold ${isImp ? "bg-amber-200 text-amber-900" : "bg-indigo-200 text-indigo-900"}">
                  ${isImp ? "IMPORTANT" : "INFO"}
                </span>
                <span class="${isImp ? "font-semibold text-amber-900" : "text-slate-700"}">${r.text}</span>
              </li>
            `;
          }).join("")}
        </ul>
      `;

      const stopsWrap = document.createElement("div");
      stopsWrap.className = "mt-4 space-y-3";

      (d.stops||[]).forEach((s) => {
        if (s.travel) {
          const travel = document.createElement("div");
          travel.className = "flex items-center gap-2 text-xs text-gray-500 pl-2";
          travel.innerHTML = `<i class="fa-solid fa-car-side text-gray-400"></i> <span class="font-semibold">äº¤é€šæ™‚é–“:</span> <span>${s.travel}</span>`;
          stopsWrap.appendChild(travel);
        }

        const stayMins = (s.start && s.end) ? minutesBetween(s.start, s.end) : null;
        const stopCard = document.createElement("div");
        stopCard.className = "bg-white rounded-2xl border border-slate-100 shadow-sm p-4";

        const mapBtn = s.map ? `<a href="${s.map}" target="_blank" class="text-indigo-700 font-semibold hover:underline"><i class="fa-solid fa-location-dot"></i> ä¸€éµé–‹åœ°åœ–</a>` : "";
        const phoneLine = s.phone ? `
          <div class="text-xs text-gray-600">
            <span class="font-semibold">é›»è©±:</span>
            <a href="tel:${String(s.phone).replace(/\s/g,'')}" class="text-indigo-700 hover:underline">${s.phone}</a>
          </div>` : "";

        stopCard.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="text-xs text-gray-500">
                ${s.start && s.end ? `<span class="font-semibold">${s.start}â€“${s.end}</span> ${stayMins ? `Â· ${humanMins(stayMins)}` : ""}` : ""}
              </div>
              <div class="font-bold text-indigo-900">${s.name}</div>
            </div>
            <div class="text-xs">${mapBtn}</div>
          </div>

          ${s.note ? `<div class="mt-2 text-sm text-gray-700"><span class="font-semibold text-slate-500">å‚™è¨»:</span> ${s.note}</div>` : ""}

          <div class="mt-2 text-xs text-gray-600 space-y-1">
            ${s.address ? `<div><span class="font-semibold">åœ°å€:</span> ${s.address}</div>` : ""}
            ${phoneLine}
          </div>
        `;
        stopsWrap.appendChild(stopCard);
      });

      body.appendChild(reminderBox);
      body.appendChild(stopsWrap);

      header.addEventListener("click", (ev) => {
        if (ev.target.closest(".copyDayBtn")) return;
        const isHidden = body.classList.contains("hidden");
        body.classList.toggle("hidden", !isHidden);
        header.querySelector(".dayToggleText").innerText = isHidden ? "æ”¶åˆ" : "å±•é–‹";
        header.querySelector(".dayChevron").classList.toggle("rotate-180", isHidden);
      });

      dayCard.appendChild(header);
      dayCard.appendChild(body);
      container.appendChild(dayCard);
    });

    container.querySelectorAll(".copyDayBtn").forEach(btn => {
      btn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        const dayId = btn.getAttribute("data-dayid");
        const dayObj = tripData.days.find(x => x.id === dayId);
        if (!dayObj) return;
        await copyTextToClipboard(buildDayText(dayObj));
        alert("å·²è¤‡è£½ï¼");
      });
    });
  }

  // ===== Multi-split expenses (Splitwise-like, partial participants) =====
  const SPLIT_LS_KEY = "trip_split_v2";

  function loadSplitState() {
    try {
      const raw = localStorage.getItem(SPLIT_LS_KEY);
      if (raw) return JSON.parse(raw);
    } catch (e) {}
    return {
      currency: "USD",
      members: ["Me"],
      expenses: [] // {id, dayId, amount, payer, splitWith[], category, note, ts}
    };
  }

  function saveSplitState(state) {
    try { localStorage.setItem(SPLIT_LS_KEY, JSON.stringify(state)); } catch(e) {}
  }

  function uid() {
    return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
  }

  function money(n) {
    const v = Number(n || 0);
    return (Math.round(v * 100) / 100).toFixed(2);
  }

  function renderSplitUI() {
    const state = loadSplitState();

    // day options
    const expDay = document.getElementById("expDay");
    expDay.innerHTML = tripData.days.map(d => `<option value="${d.id}">${d.label} Â· ${d.title}</option>`).join("");

    // payer options
    const expPayer = document.getElementById("expPayer");
    expPayer.innerHTML = state.members.map(m => `<option value="${m}">${m}</option>`).join("");

    // members chips
    const membersList = document.getElementById("membersList");
    membersList.innerHTML = state.members.map(m => `
      <span class="bg-indigo-50 border border-indigo-200 text-indigo-900 px-3 py-1 rounded-full text-sm flex items-center gap-2">
        ${m}
        ${state.members.length > 1 ? `<button class="removeMemberBtn text-indigo-700 hover:text-red-600" data-name="${m}" title="remove">âœ•</button>` : ""}
      </span>
    `).join("");

    // splitWith checkboxes (default: all checked)
    const splitBox = document.getElementById("splitWithBox");
    splitBox.innerHTML = state.members.map(m => `
      <label class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-full px-3 py-1 text-sm cursor-pointer">
        <input type="checkbox" class="splitWithChk" value="${m}" checked>
        <span>${m}</span>
      </label>
    `).join("");

    // expense list
    const list = document.getElementById("expenseList");
    list.innerHTML = state.expenses
      .slice()
      .sort((a,b)=> (b.ts||0)-(a.ts||0))
      .map(e => {
        const dayObj = tripData.days.find(d => d.id === e.dayId);
        const dayLabel = dayObj ? dayObj.label : e.dayId;
        return `
          <div class="border border-slate-200 rounded-xl p-3 flex items-start justify-between gap-2">
            <div>
              <div class="text-xs text-gray-500">${dayLabel} Â· ${e.category}</div>
              <div class="font-semibold text-slate-800">${e.payer} ä»˜ ${state.currency} ${money(e.amount)}</div>
              <div class="text-xs text-gray-600">åˆ†æ”¤ï¼š${(e.splitWith||[]).join(", ") || "â€”"}</div>
              ${e.note ? `<div class="text-xs text-gray-600 mt-1">å‚™è¨»ï¼š${e.note}</div>` : ""}
            </div>
            <button class="removeExpenseBtn text-sm text-red-600 hover:underline" data-id="${e.id}">åˆªé™¤</button>
          </div>
        `;
      }).join("");

    renderSettlement(state);

    // wire remove member
    membersList.querySelectorAll(".removeMemberBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const name = btn.dataset.name;
        const st = loadSplitState();
        if (st.members.length <= 1) return;

        st.members = st.members.filter(x => x !== name);
        st.expenses = st.expenses.filter(e => e.payer !== name && !(e.splitWith||[]).includes(name));
        saveSplitState(st);
        renderSplitUI();
      });
    });

    // wire remove expense
    list.querySelectorAll(".removeExpenseBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const st = loadSplitState();
        st.expenses = st.expenses.filter(e => e.id !== id);
        saveSplitState(st);
        renderSplitUI();
      });
    });
  }

  function computeBalances(state) {
    // balance > 0 means should receive; < 0 means owes
    const bal = {};
    state.members.forEach(m => bal[m] = 0);

    for (const e of state.expenses) {
      const amt = Number(e.amount || 0);
      const payer = e.payer;
      const splitWith = (e.splitWith && e.splitWith.length) ? e.splitWith : [];
      const people = splitWith.length;

      if (!(payer in bal)) bal[payer] = 0;
      bal[payer] += amt;

      if (people > 0) {
        const share = amt / people;
        for (const p of splitWith) {
          if (!(p in bal)) bal[p] = 0;
          bal[p] -= share;
        }
      }
    }

    for (const k of Object.keys(bal)) bal[k] = Math.round(bal[k] * 100) / 100;
    return bal;
  }

  function suggestTransfers(balances) {
    const creditors = [];
    const debtors = [];
    for (const [name, val] of Object.entries(balances)) {
      if (val > 0.009) creditors.push([name, val]);
      else if (val < -0.009) debtors.push([name, -val]);
    }
    creditors.sort((a,b)=> b[1]-a[1]);
    debtors.sort((a,b)=> b[1]-a[1]);

    const transfers = [];
    let i=0, j=0;
    while (i < debtors.length && j < creditors.length) {
      const [dName, dAmt] = debtors[i];
      const [cName, cAmt] = creditors[j];
      const pay = Math.min(dAmt, cAmt);

      transfers.push({ from: dName, to: cName, amount: Math.round(pay*100)/100 });

      debtors[i][1] = Math.round((dAmt - pay)*100)/100;
      creditors[j][1] = Math.round((cAmt - pay)*100)/100;

      if (debtors[i][1] <= 0.009) i++;
      if (creditors[j][1] <= 0.009) j++;
    }
    return transfers;
  }

  function renderSettlement(state) {
    const balances = computeBalances(state);
    const transfers = suggestTransfers(balances);
    const box = document.getElementById("settlementList");

    if (!state.expenses.length) {
      box.innerHTML = `<div class="text-gray-500">ç›®å‰é‚„æ²’æœ‰èŠ±è²»æ˜ç´°ã€‚</div>`;
      return;
    }

    const currency = state.currency || "USD";
    const lines = [];
    lines.push(`<div class="text-xs text-gray-500 mb-2">æ­£æ•¸ï¼æ‡‰æ”¶ / è² æ•¸ï¼æ‡‰ä»˜ï¼ˆæ¯ç­†ä¾ã€Œåˆ†æ”¤å°è±¡ã€å¹³å‡åˆ†ï¼‰</div>`);
    lines.push(`<div class="text-sm">${Object.entries(balances).map(([n,v]) => `${n}: <b>${currency} ${money(v)}</b>`).join(" Â· ")}</div>`);
    lines.push(`<div class="mt-2 font-semibold">å»ºè­°è½‰å¸³ï¼š</div>`);

    if (!transfers.length) {
      lines.push(`<div class="text-emerald-700 font-semibold">å·²çµæ¸… âœ…</div>`);
    } else {
      lines.push(`<ul class="list-disc pl-5 space-y-1">` + transfers.map(tr =>
        `<li><b>${tr.from}</b> â†’ <b>${tr.to}</b>ï¼š${currency} ${money(tr.amount)}</li>`
      ).join("") + `</ul>`);
    }

    box.innerHTML = lines.join("");
  }

  function initSplitHandlers() {
    document.getElementById("addMemberBtn").addEventListener("click", () => {
      const name = (document.getElementById("memberNameInput").value || "").trim();
      if (!name) return;

      const st = loadSplitState();
      if (st.members.includes(name)) return;

      st.members.push(name);
      saveSplitState(st);
      document.getElementById("memberNameInput").value = "";
      renderSplitUI();
    });

    document.getElementById("addExpenseBtn").addEventListener("click", () => {
      const st = loadSplitState();

      const amount = Number(document.getElementById("expAmount").value || 0);
      const payer = document.getElementById("expPayer").value;
      const category = document.getElementById("expCategory").value;
      const dayId = document.getElementById("expDay").value;
      const note = (document.getElementById("expNote").value || "").trim();

      const splitWith = Array.from(document.querySelectorAll(".splitWithChk"))
        .filter(chk => chk.checked)
        .map(chk => chk.value);

      if (!amount || amount <= 0) return alert("è«‹å¡«é‡‘é¡");
      if (!payer) return alert("è«‹é¸ä»˜æ¬¾äºº");
      if (!splitWith.length) return alert("è‡³å°‘å‹¾é¸ä¸€ä½åˆ†æ”¤å°è±¡");

      st.expenses.push({
        id: uid(),
        dayId,
        amount,
        payer,
        splitWith,
        category,
        note,
        ts: Date.now()
      });

      saveSplitState(st);

      document.getElementById("expAmount").value = "";
      document.getElementById("expNote").value = "";
      renderSplitUI();
    });
  }

  // ===== Expenses accordion =====
  function initExpensesAccordion() {
    const btn = document.getElementById("toggleExpensesBtn");
    const panel = document.getElementById("expensesPanel");
    const label = document.getElementById("toggleExpensesLabel");

    btn.addEventListener("click", () => {
      const open = panel.classList.contains("hidden");
      panel.classList.toggle("hidden");
      label.innerText = open ? "æ”¶åˆ" : "å±•é–‹";
    });
  }

  // ===== Copy today =====
  function initCopyToday() {
    document.getElementById("copyTodayBtn").addEventListener("click", async () => {
      const d = getTodayOrFirstTripDay();
      await copyTextToClipboard(buildDayText(d));
      alert("å·²è¤‡è£½ä»Šå¤©è¡Œç¨‹ï¼");
    });
  }

  // ===== Init =====
  document.getElementById("lastUpdatedBadge").innerText = formatLastUpdated();
  renderDays();
  initCopyToday();

  initExpensesAccordion();
  initSplitHandlers();
  renderSplitUI();
</script>
</body>
</html>
